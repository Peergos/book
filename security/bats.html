<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Block access control - </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "../";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="../overview/overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li><a href="../features/features.html"><strong aria-hidden="true">2.</strong> Features</a></li><li><ol class="section"><li><a href="../features/self.html"><strong aria-hidden="true">2.1.</strong> Self hosting</a></li><li><a href="../features/p2p.html"><strong aria-hidden="true">2.2.</strong> Peer-to-peer</a></li><li><a href="../features/trust.html"><strong aria-hidden="true">2.3.</strong> Trust free server</a></li><li><a href="../features/multi.html"><strong aria-hidden="true">2.4.</strong> Multi-device login</a></li><li><a href="../features/web.html"><strong aria-hidden="true">2.5.</strong> Web interface</a></li><li><a href="../features/social.html"><strong aria-hidden="true">2.6.</strong> Social</a></li><li><a href="../features/sharing.html"><strong aria-hidden="true">2.7.</strong> Sharing</a></li><li><a href="../features/large.html"><strong aria-hidden="true">2.8.</strong> Large files</a></li><li><a href="../features/streaming.html"><strong aria-hidden="true">2.9.</strong> Streaming</a></li><li><a href="../features/viewers.html"><strong aria-hidden="true">2.10.</strong> File viewers</a></li><li><a href="../features/secret.html"><strong aria-hidden="true">2.11.</strong> Secret links</a></li><li><a href="../features/migration.html"><strong aria-hidden="true">2.12.</strong> Migration</a></li><li><a href="../features/sync.html"><strong aria-hidden="true">2.13.</strong> File Sync</a></li><li><a href="../features/open.html"><strong aria-hidden="true">2.14.</strong> Open source</a></li></ol></li><li><a href="../architecture/architecture.html"><strong aria-hidden="true">3.</strong> Architecture</a></li><li><ol class="section"><li><a href="../architecture/logical.html"><strong aria-hidden="true">3.1.</strong> Logical</a></li><li><a href="../architecture/physical.html"><strong aria-hidden="true">3.2.</strong> Physical</a></li><li><a href="../architecture/immutable.html"><strong aria-hidden="true">3.3.</strong> Immutable data</a></li><li><a href="../architecture/mutable.html"><strong aria-hidden="true">3.4.</strong> Mutable pointers</a></li><li><a href="../architecture/writer.html"><strong aria-hidden="true">3.5.</strong> Writing subspaces</a></li><li><a href="../architecture/champ.html"><strong aria-hidden="true">3.6.</strong> Merkle-CHAMP</a></li><li><a href="../architecture/pki.html"><strong aria-hidden="true">3.7.</strong> Usernames</a></li><li><a href="../architecture/follow.html"><strong aria-hidden="true">3.8.</strong> Follow requests</a></li></ol></li><li><a href="../security/security.html"><strong aria-hidden="true">4.</strong> Security</a></li><li><ol class="section"><li><a href="../security/trust.html"><strong aria-hidden="true">4.1.</strong> Trust free layers</a></li><li><a href="../security/threats.html"><strong aria-hidden="true">4.2.</strong> Threat models</a></li><li><a href="../security/login.html"><strong aria-hidden="true">4.3.</strong> Login</a></li><li><a href="../security/encryption.html"><strong aria-hidden="true">4.4.</strong> Encryption</a></li><li><a href="../security/bats.html" class="active"><strong aria-hidden="true">4.5.</strong> Block access control</a></li><li><a href="../security/cryptree.html"><strong aria-hidden="true">4.6.</strong> File access control</a></li><li><a href="../security/meta.html"><strong aria-hidden="true">4.7.</strong> Metadata</a></li><li><a href="../security/quantum.html"><strong aria-hidden="true">4.8.</strong> Quantum resistance</a></li><li><a href="../security/social.html"><strong aria-hidden="true">4.9.</strong> Social graph</a></li><li><a href="../security/pki.html"><strong aria-hidden="true">4.10.</strong> PKI</a></li></ol></li><li><a href="../dev/details.html"><strong aria-hidden="true">5.</strong> How does it work?</a></li><li><ol class="section"><li><a href="../dev/signup.html"><strong aria-hidden="true">5.1.</strong> Signing up</a></li><li><a href="../dev/upload.html"><strong aria-hidden="true">5.2.</strong> Uploading a file</a></li><li><a href="../dev/follow.html"><strong aria-hidden="true">5.3.</strong> Sending a follow request</a></li><li><a href="../dev/proxy.html"><strong aria-hidden="true">5.4.</strong> Proxying requests</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1> 

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#block-access-control" id="block-access-control"><h1>Block Access Control</h1></a>
<p>When an app on IPFS wants a block of data, it asks IPFS for the data corresponding to its content identifier, or <a href="https://docs.ipfs.io/concepts/content-addressing/#identifier-formats">CID</a> (basically, a hash of the data). IPFS will then search the global IPFS network for nodes that have this CID. At the same time, it will ask any nodes it's already in contact with: &quot;Do you have this CID?&quot;. Any contacted node that has the block can respond with the data. A nice property of this is that any node that has the content can serve it up, which means that it autoscales to demand.</p>
<p><center>
<img src="/img/bitswap-authed.png" alt="authed" />
<br/>
Authed bitswap retrieving a block.
</center></p>
<p>We have extended this protocol to have an optional auth string paired with every CID. In Peergos, this auth string is an <a href="https://docs.aws.amazon.com/AmazonS3/latest/API/sig-v4-header-based-auth.html">S3 V4 signature</a>, which is time-limited, includes the CID, and is tied to the requesting node's public key (to prevent replay attacks). A replay attack would be if it were possible for someone without the block, who we had sent a valid auth token, to retrieve the block themselves directly using the token. As an anology, consider a ticketed event. If someone buys a ticket, and then a friend of theirs copies the ticket and uses that to gain entry, that is a replay attack. If, however, the tickets included the buyer's name on the ticket (they were non-transferable) and the event verified the holder's name on entry then the friend couldn't get in, even with the original ticket.</p>
<p>We do a similar thing to avoid this by using the source node's public key as the domain in the S3 request. This way we can broadcast a cid and auth string to the network and no one but us can use that auth string. The S3 V4 signature scheme is essentially repeated <a href="https://en.wikipedia.org/wiki/HMAC">hmac-sha256</a> and needs a secret key to function. Such a secret key would grant the holder access to the block, so we call it a Block Access Token or BAT for short, and each is 32 bytes long. Since it only depends on hmac-sha256, which itself only depends on sha256, it is post-quantum - a large quantum computer does not break it.</p>
<p>The primary BAT used for this authentication is derived from the block itself. This means any instance that retrieves such a block (after being authorised) can continue to serve it up and enforce the same access control, thus maintaining the autoscaling properties in a privacy-preserving way.</p>
<p>There are two formats of blocks in Peergos, cbor and raw. Raw blocks are the most sensitive (they hold users' encrypted data) and are just fragments of ciphertext with no additional structure. Cbor blocks are valid <a href="https://ipld.io/docs/codecs/known/dag-cbor/">dag-cbor</a> structured IPLD objects which can reference other blocks. How could we put a BAT in these blocks? In a cbor block, it is easy to choose a canonical place to put a list of BATs. If the cbor is a map object, we put a list of BATs at the top level under the key &quot;bats&quot;.</p>
<p><center>
<img src="/img/cbor-bats.png" alt="cbor-block-auth" />
<br/>
Structure for storing BATs in cbor blocks
</center></p>
<p>For raw objects, it is a little more difficult, as we also need to support raw blocks that do not have a BAT (either legacy blocks or ones specifically made public). Our design uses a detectable prefix of 8 FIXED bytes followed by a cbor list of BATs before the actual ciphertext of the block.</p>
<p><center>
<img src="/img/raw-bats.png" alt="raw-bock-auth" />
<br/>
Structure for storing BATs in the prefix of a raw block
</center></p>
<p>We normally have two bats per block. One is inline - and specific to that block only. The other is a user wide &quot;mirror&quot; BAT - and referenced in the block by its hash. The mirror BAT is for when a user wants to mirror all their data on another instance, or migrate to another instance.</p>
<table><thead><tr><th> </th><th> Chunk 1                </th><th>  Chunk 2     </th><th> Chunk 3 </th></tr></thead><tbody>
<tr><td> BAT stream secret </td><td> Sb (encrypted in base data)  </td><td>                    </td><td>    </td></tr>
<tr><td> BAT[] (unencrypted in root cbor object under &quot;bats&quot;) </td><td> B1=randomBytes(32)                </td><td> B2=hash(Sb + B1) </td><td> B3=hash(Sb + B2) </td></tr>
</tbody></table>
<p><center>
BAT derivation for subsequent chunks of a file
</center></p>
<p>Each 5 MiB chunk of a file or directory has its own unique BAT, so the server still cannot link the different blocks of a file to deduce the padded size of the file. Subsequent chunk BATs within a file are <a href="/posts/fast-seeking">derived</a> in the same way as we do the CHAMP labels, by hashing the current chunk BAT with a stream-secret, stored encrypted in the first chunk. This maintains our ability to seek within arbitrarily large files without any IO operations (just local hashing and then a final lookup of the requested chunk). When someone's access to a file or directory is revoked, the BATs are also changed, making it impossible to retrieve the new ciphertext even with previous access.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../security/encryption.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../security/cryptree.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../security/encryption.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../security/cryptree.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
